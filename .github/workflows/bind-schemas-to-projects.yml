name: Bind Schemas to HTAN2 Projects

on:
  # Manual trigger only - gives full control over when and which schemas to bind
  workflow_dispatch:
    inputs:
      schema_version:
        description: 'Schema version to bind (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      data_model_repo:
        description: 'HTAN2 data model repository (e.g., ncihtan/htan2-data-model)'
        required: true
        default: 'ncihtan/htan2-data-model'
      folder_types:
        description: 'Folder types to bind (e.g., v8_ingest v8_staging v8_release). Leave empty to bind all. Separate multiple with spaces.'
        required: false
        default: ''

env:
  PYTHON_VERSION: '3.11'
  ORGANIZATION_NAME: 'HTAN2Organization'

jobs:
  bind-schemas-to-projects:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: pip install --upgrade pip && pip install -r requirements.txt
    
    - name: Determine schema version
      id: version
      run: |
        # Manual trigger only - use input
        echo "version=${{ github.event.inputs.schema_version }}" >> $GITHUB_OUTPUT
        echo "Schema version: ${{ steps.version.outputs.version }}"
    
    - name: Download schemas from htan2-data-model release
      run: |
        # Create schemas directory
        mkdir -p schemas
        
        # Download schemas from the htan2-data-model repository
        SCHEMA_VERSION=${{ steps.version.outputs.version }}
        REPO="ncihtan/htan2-data-model"
        
        echo "Downloading schemas from $REPO version $SCHEMA_VERSION"
        
        # Get the list of available schema files from the JSON_Schemas directory
        echo "Fetching available schema files from JSON_Schemas/$SCHEMA_VERSION..."
        SCHEMA_FILES=$(curl -s "https://api.github.com/repos/$REPO/contents/JSON_Schemas/$SCHEMA_VERSION" | \
          jq -r '.[].name | select(endswith(".json"))' | \
          sort)
        
        echo "Available schema files:"
        echo "$SCHEMA_FILES"
        
        # Download each schema file
        for schema_file in $SCHEMA_FILES; do
          echo "Downloading $schema_file schema..."
          curl -L -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/$REPO/contents/JSON_Schemas/$SCHEMA_VERSION/$schema_file" \
            -o "schemas/$schema_file"
        done
        
        # List downloaded schemas
        echo "Downloaded schemas:"
        ls -la schemas/
        
        # Create a list of available schema names for later use
        echo "$SCHEMA_FILES" > available_schemas.txt
        echo "Available schemas saved to available_schemas.txt"
    
    - name: Bind file-based schemas to project subfolders
      env:
        SYNAPSE_PAT: ${{ secrets.SYNAPSE_PAT }}
        SYNAPSE_USERNAME: ${{ secrets.SYNAPSE_USERNAME }}
        SCHEMA_VERSION: ${{ steps.version.outputs.version }}
      run: |
        echo "Binding schemas to project subfolders..."
        echo "Schema version: $SCHEMA_VERSION"
        
        # Load project configuration
        echo "Loading project configuration from projects.yml and schema_binding_config.yml..."
        
        # Read available schemas from the downloaded list
        AVAILABLE_SCHEMAS=$(cat available_schemas.txt)
        echo "Available schemas from repository: $AVAILABLE_SCHEMAS"
        
        # Process file-based schemas from config
        echo "Processing file-based schemas from configuration..."
        
        # Build command with optional folder-type filter
        BIND_CMD="python scripts/bind_schemas_workflow.py"
        if [ -n "${{ github.event.inputs.folder_types }}" ]; then
          echo "Filtering to folder types: ${{ github.event.inputs.folder_types }}"
          BIND_CMD="$BIND_CMD --folder-type-filter ${{ github.event.inputs.folder_types }}"
        else
          echo "Binding to all folder types in config"
        fi
        
        # Process file-based schemas using the dedicated script
        $BIND_CMD
        
        # TODO: Expand to bind all file-based schemas to all projects with existing subfolders
        # This can be done by iterating through the schema_binding_config.yml configuration
    
    - name: Create binding summary
      if: always()
      run: |
        echo "Creating binding summary..."
        
        # Check if binding results exist
        if [ -f binding_results.json ]; then
          SUCCESSFUL=$(jq '.successful | length' binding_results.json)
          FAILED=$(jq '.failed | length' binding_results.json)
          SKIPPED=$(jq '.skipped | length' binding_results.json)
        else
          SUCCESSFUL=0
          FAILED=0
          SKIPPED=0
        fi
        
        cat > schema_binding_summary.md << EOF
        # Schema Binding Summary
        
        **Date**: $(date)
        **Schema Version**: ${{ steps.version.outputs.version }}
        **Repository**: ${{ github.event.inputs.data_model_repo || 'ncihtan/htan2-data-model' }}
        
        ## Binding Results
        
        - ✅ **Successful**: $SUCCESSFUL binding(s)
        - ❌ **Failed**: $FAILED binding(s)
        - ⏭️  **Skipped**: $SKIPPED schema(s)
        
        EOF
        
        # Add failed bindings if any
        if [ -f binding_results.json ] && [ "$FAILED" -gt 0 ]; then
          echo "" >> schema_binding_summary.md
          echo "## ❌ Failed Bindings" >> schema_binding_summary.md
          echo "" >> schema_binding_summary.md
          jq -r '.failed[] | "- **\(.schema)** → \(.project) (\(.synapse_id))**\n  - Subfolder: \(.subfolder)\n  - Error: \(.error)"' binding_results.json >> schema_binding_summary.md
        fi
        
        # Add skipped schemas if any
        if [ -f binding_results.json ] && [ "$SKIPPED" -gt 0 ]; then
          echo "" >> schema_binding_summary.md
          echo "## ⏭️  Skipped Schemas" >> schema_binding_summary.md
          echo "" >> schema_binding_summary.md
          jq -r '.skipped[] | "- **\(.schema)**: \(.reason)\n  - Projects: \(.projects | join(", "))"' binding_results.json >> schema_binding_summary.md
        fi
        
        # Add successful bindings summary
        if [ -f binding_results.json ] && [ "$SUCCESSFUL" -gt 0 ]; then
          echo "" >> schema_binding_summary.md
          echo "## ✅ Successful Bindings" >> schema_binding_summary.md
          echo "" >> schema_binding_summary.md
          echo "Total: $SUCCESSFUL binding(s) completed successfully" >> schema_binding_summary.md
          echo "" >> schema_binding_summary.md
          echo "### By Schema:" >> schema_binding_summary.md
          jq -r '.successful | group_by(.schema) | .[] | "- **\(.[0].schema)**: \(length) binding(s)"' binding_results.json >> schema_binding_summary.md
          echo "" >> schema_binding_summary.md
          echo "### By Project:" >> schema_binding_summary.md
          jq -r '.successful | group_by(.project) | .[] | "- **\(.[0].project)**: \(length) binding(s)"' binding_results.json >> schema_binding_summary.md
        fi
        
        echo "" >> schema_binding_summary.md
        echo "## Next Steps" >> schema_binding_summary.md
        echo "" >> schema_binding_summary.md
        if [ "$FAILED" -gt 0 ]; then
          echo "- ⚠️  Review failed bindings above and fix any issues" >> schema_binding_summary.md
        fi
        echo "- Verify schemas are properly bound in Synapse" >> schema_binding_summary.md
        echo "- Test file uploads with schema validation" >> schema_binding_summary.md
        echo "- Check fileview functionality" >> schema_binding_summary.md
        
        echo ""
        echo "Summary created:"
        cat schema_binding_summary.md
    
    - name: Upload binding summary as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: schema-binding-summary-${{ steps.version.outputs.version }}
        path: |
          schema_binding_summary.md
          binding_results.json
        retention-days: 30
